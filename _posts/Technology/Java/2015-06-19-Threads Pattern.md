---

layout: post
title: Java多线程设计模式与C10K问题
category: 技术
tags: Java
keywords: 多线程 JAVA

---

## 前言

java性能的提高，io和多线程是其中两个重要部分，io方面java实现了nio和aio，线程则有一系列的设计模式和lambda表达式的支持，相信java在以后的很长一段时间，还会继续发光发热的。

了解一些设计模式，不仅可以提高编程能力，对学习一些框架的源码也是很有帮助的。

## 线程安全

编写多线程程序时，一个逃不过的坑就是线程安全。

### 什么导致线程不安全

大学课本上的操作系统原理，只说了多线程要处理资源的争用，没有直接说下面的事

1. 多个线程操作同一块内存（比如变量），这个是最主要的。
2. 重排序：编译器，为了优化所做的重排序；处理器，硬件指令重拍排序
2. 缓存：CPU各个核心虽然共用一个内存，但都有自己的缓存
3. 在原子性：比如count++，再字节码中则体现为"读取-修改-写入"。在多线程环境下，某个线程操作的值可能已经失效。

### 如何确保线程安全

基本的思路是针对上述线程不安全的原因进行规避。

1. 我们自己写代码时，尽量安全的操作共享内存。比如在操作变量时加锁。
2. 编写并使用线程安全对象。比如使用ConcurrentHashMap来替代HashMap，通过继承和组合等方式，在现有的线程安全类的基础上扩展新的类等
3. 使用线程工具类

    - 同步类，比如vector等，同一个时刻只有一个线程可以操作容器数据
    - 并行类，比如ConcurrentHashMap，同一个时刻可以有多个线程操作容器数据，其本身负责线程安全。
    - 同步工具类，同步工具类都包含一些特定的结构化属性，它们封装了一些状态，这些状态将决定了执行同步工具类的线程是继续执行还是等待（即可以根据自身的状态来协调线程的控制流），此外还提供了一些方法对状态进行操作，以及另一些方法用于高效的等待同步工具类进入到预期状态。（来自《Java并行编程实战》）

## 线程之间如何发生关系（待整理）

线程之间影响彼此的办法，根本上就是共享数据，具体的说是，相关线程操作数据来影响彼此（前提是相关线程，都有操作共享数据数据的手段）。同步和锁，本质上也是如此。

此处以两个线程为例

### 共享数据

1. 显式，数据作为双方的参数

        main(){
            Data data;
            New ThreadA(data).start();
            New ThreadB(data).start();  
        }
        
2. 隐式，这个有很多，不再列举
    

### 收发消息

生产者和消费者模式的本质是中间有一个队列，从而**将线程之间的共享数据转化成生产者线程与消费者线程收发消息**，“收发消息”有一个问题，那就是结果的返回。

Future、Callable、Executor这一套体系解决了消费者处理完消息（也就是task）之后的返回值问题。封装了“数据从生产者线程发到消费者线程，返回结果从消费者线程发到生产者线程”的过程，为java的并发编程提供了新的“设计模式”。


## 引用

[Java多线程设计模式（一）][]

[Promise, Future 和 Callback][]

[JAVA并发设计模式学习笔记（一）—— JAVA多线程编程][]

[JAVA并发设计模式学习笔记（一）—— JAVA多线程编程]: http://www.cnblogs.com/chenying99/p/3321866.html
[Java多线程设计模式（一）]: http://www.cnblogs.com/chenying99/p/3322032.html
[Promise, Future 和 Callback]: http://isouth.org/archives/354.html